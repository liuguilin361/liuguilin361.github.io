<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://liuguilin361.github.io name=base><title>
         Hacking a Silent Disco
        
    </title><meta content="Hacking a Silent Disco" property=og:title><link href=https://liuguilin361.github.io/fonts.css rel=stylesheet><script data-host-url=https://api-gateway.umami.dev/ data-website-id=74344cd8-1e87-4c38-8acd-f96049b8f07e defer src=/js/imamu.js></script><script async data-goatcounter=https://not-matthias.goatcounter.com/count src=https://liuguilin361.github.io/js/count.js></script><noscript><img src="https://not-matthias.goatcounter.com//count?p=/posts/hacking-a-silent-disco/&t=Hacking a Silent Disco"></noscript><link title="liuguilin's blog" href=https://liuguilin361.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://liuguilin361.github.io/theme/light.css rel=stylesheet><link href=https://liuguilin361.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://liuguilin361.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://liuguilin361.github.io/main.css media=screen rel=stylesheet><script src="https://liuguilin361.github.io/search_index.en.js?h=b0e86fa6164ec2b23997" defer></script><script src="https://liuguilin361.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://liuguilin361.github.io>liuguilin's blog</a><div class=socials><a class=social href=https://twitter.com/not_matthias rel=me> <img alt=twitter src=https://liuguilin361.github.io/icons/social/twitter.svg> </a><a class=social href=https://github.com/liuguilin361/ rel=me> <img alt=github src=https://liuguilin361.github.io/icons/social/github.svg> </a></div></div><nav><a href=https://liuguilin361.github.io/posts style=margin-left:.25em>/posts</a><a href=https://liuguilin361.github.io/tags style=margin-left:.25em>/tags</a><a href=https://liuguilin361.github.io/projects style=margin-left:.25em>/projects</a><a href=https://liuguilin361.github.io/talks style=margin-left:.25em>/talks</a><a href=https://liuguilin361.github.io/about style=margin-left:.25em>/about</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://liuguilin361.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://liuguilin361.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://liuguilin361.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Hacking a Silent Disco<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2023-10-21</time> :: 1572 Words <span class=tags-label> :: Tags:</span><span class=tags> <a class=post-tag href=https://liuguilin361.github.io/tags/reverse-engineering/>reverse engineering</a> </span></div></div><section class=body><h1 id=introduction>Introduction</h1><p>A while ago while I was partying at a silent disco bar, I noticed something interesting: They have a digital jukebox - basically a website that lets people choose which music should be played. People can add songs or vote for existing ones. The song with the most votes will be played next.<p>I tried to add <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">my own song</a>, but I didn't get any votes so I did the only logical thing: I reverse engineered the website and wrote a bot to vote for my song.<p><img alt src=https://liuguilin361.github.io/posts/hacking-a-silent-disco/./rick-astley-kiosk.jpeg><h1 id=how-does-it-work>How does it work?</h1><p>Let's take a step back. How does the Jukebox even work? It's quite straightforward. You go to the website and add the song you want or vote for other songs:<div style=width:100%;height:0;padding-bottom:64.923%;position:relative><iframe allowfullscreen frameborder=0 height=100% src=https://streamable.com/e/nt1ogw style=width:100%;height:100%;position:absolute;top:0;left:0;overflow:hidden width=100%></iframe></div><h1 id=reverse-engineering-it>Reverse Engineering it</h1><p>Since it's a web app, the first thing I looked at was the network requests. I quickly realized, they are using websockets, since I saw no network requests when voting. After finding the <code>wss://s-usc1f-nss-2524.firebaseio.com/.ws?v=5&ns=festify-79b08</code> websocket request, I was able to view all the messages:<div style=width:100%;height:0;padding-bottom:64.923%;position:relative><iframe allowfullscreen frameborder=0 height=100% src=https://streamable.com/e/z40fhm style=width:100%;height:100%;position:absolute;top:0;left:0;overflow:hidden width=100%></iframe></div><p>The JSON data looked strange, and only parts made sense so I searched for it on the internet. I then found out that they are using a <a href=https://firebase.google.com/docs/database>Firebase Realtime Database</a> to store the data.<h1 id=firebase-realtime-database-wire-protocol>Firebase Realtime Database Wire Protocol</h1><p>Turns out, the websocket is part of the undocumented Firebase Wire Protocol. Luckily, some people have already reverse engineered it and documented some parts. Why? Writing a custom backend is useful when Google could kill Firebase tomorrow and add it to their <a href=https://killedbygoogle.com/>graveyard</a>.<h2 id=encoding>Encoding</h2><p>All the websocket messages are JSON encoded. They only use single letter names, which makes it hard to understand but reduces the total amount of space per message. Luckily, the <a href=https://github.com/firebase/firebase-ios-sdk/blob/7502fe3d09c23a90938bdd18ca0c2b64d711ec32/FirebaseDatabase/Sources/Constants/FConstants.m>iOS SDK</a> documented them in a single file.<p>I'll use the following format in this article:<ul><li>The original name of the field is denoted in brackets (e.g. <code>t</code> for <code>[t]ype</code>)<li>Values that are not fixed are denoted with <code><...></code> (e.g. <code>&LTdata_msg></code>)<li>Fixed values will be shown as strings or numbers.</ul><p>The JSON message is wrapped in a data message envelope, which is used to send arbitrary data messages to the server.<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[t]ype"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"data"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"[d]ata"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTdata_msg>
</span><span>}
</span></code></pre><p>The data message will always have the following format. If the data message is a response, the action field is excluded. The request number is a sequential number used to match requests and responses.<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[r]equest_num"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LT1337>,
</span><span>  </span><span style=color:#86b300>"[a]ction"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTaction>,
</span><span>  </span><span style=color:#86b300>"[b]ody"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTbody>
</span><span>}
</span></code></pre><p>The total body for each message, looks like this:<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[t]ype"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"data"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"[d]ata"</span><span style=color:#61676ccc>: </span><span>{
</span><span>    </span><span style=color:#86b300>"[r]equest_num"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LT1337>,
</span><span>    </span><span style=color:#86b300>"[a]ction"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTaction>,
</span><span>    </span><span style=color:#86b300>"[b]ody"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTbody>
</span><span>  }
</span><span>}
</span></code></pre><p>For the sake of readability, only the body will be shown in the following examples.<h2 id=auth-request>Auth Request</h2><details><summary>Metadata</summary> <ul><li>Action: <code>auth</code></ul></details><hr><p>To be able to operate on the database, you need to authenticate. The permissions and paths can be configured for every Firebase project in a <a href=https://github.com/Festify/app/blob/develop/database.rules.bolt>database.rules.bolt</a> file.<p>The body contains the <a href=https://openid.net/specs/openid-connect-core-1_0.html#IDToken>id_token</a> generated via the Firebase REST API (see <a href=https://liuguilin361.github.io/posts/hacking-a-silent-disco/#sign-in>next section</a>), which looks like this:<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"cred"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTid_token>
</span><span>}
</span></code></pre><p>The response includes the <code>user_id</code>, <code>id_token</code> and other information. Only the <code>user_id</code> is needed for further requests.<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"status"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"ok"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"data"</span><span style=color:#61676ccc>: </span><span>{
</span><span>    </span><span style=color:#86b300>"auth"</span><span style=color:#61676ccc>: </span><span>{
</span><span>      </span><span style=color:#86b300>"provider"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"anonymous"</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"provider_id"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"anonymous"</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"user_id"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"482MnymvNFU63WRznog2yPEq4Vz2"</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"token"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTid_token>,
</span><span>      </span><span style=color:#86b300>"uid"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"482MnymvNFU63WRznog2yPEq4Vz2"
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"expires"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1695466112
</span><span>  }
</span><span>}
</span></code></pre><h3 id=sign-in>Sign in anonymously</h3><p>Firebase uses <a href=https://openid.net/connect/>OpenID Connect</a> for authentication. The <code>anonymous</code> provider is used to sign in anonymously. To generate an <code>id_token</code> and <code>refresh_token</code>, we can use the <a href=https://firebase.google.com/docs/reference/rest/auth>Firebase Auth REST API</a>.<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>curl </span><span style=color:#86b300>'https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=&LTcensored>' </span><span style=color:#61676ccc>\
</span><span style=color:#ff8f40>  -H </span><span style=color:#86b300>'Content-Type: application/json' </span><span style=color:#61676ccc>\
</span><span style=color:#ff8f40>  --data-binary </span><span style=color:#86b300>'{"returnSecureToken":true}' </span><span style=color:#61676ccc>\
</span><span style=color:#ff8f40>  --referer</span><span> https://festify.us/
</span></code></pre><p>We need to modify the referer header, otherwise our request will be blocked. This is a security feature, but can be easily bypassed. Fun fact: The referer header <a href=https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_header_name>can't be set in a browser</a> (which is probably a good thing).<p>The response will contain the <code>id_token</code> which can be used to authenticate:<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"idToken"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTid_token>,
</span><span>  </span><span style=color:#86b300>"email"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>""</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"refreshToken"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTrefresh_token>,
</span><span>  </span><span style=color:#86b300>"expiresIn"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"3600"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"localId"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTlocal_id>
</span><span>}
</span></code></pre><h3 id=exchange-refresh-token>Exchange Refresh Token</h3><p>The <code>id_token</code> is valid for one hour. To get a new one, we can exchange the refresh token as <a href=https://firebase.google.com/docs/reference/rest/auth#section-refresh-token>specified in the documentation</a>.<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>curl </span><span style=color:#86b300>'https://securetoken.googleapis.com/v1/token?key=&LTcensored>' </span><span style=color:#61676ccc>\
</span><span style=color:#ff8f40>  -H </span><span style=color:#86b300>'Content-Type: application/x-www-form-urlencoded' </span><span style=color:#61676ccc>\
</span><span style=color:#ff8f40>  --data </span><span style=color:#86b300>'grant_type=refresh_token&refresh_token=&LTrefresh_token>' </span><span style=color:#61676ccc>\
</span><span style=color:#ff8f40>  --referer</span><span> https://festify.us/
</span></code></pre><h2 id=listen-request>Listen Request</h2><details><summary>Metadata</summary> <ul><li>Action: <code>q</code></ul></details><hr><p>The listen request is used to query the database. It will return the current value and all future updates. All constants related to queries can be found in the <a href=https://github.com/firebase/firebase-ios-sdk/blob/7502fe3d09c23a90938bdd18ca0c2b64d711ec32/FirebaseDatabase/Sources/Constants/FConstants.m#L120-L131>iOS SDK</a> again.<p>The body contains the following fields:<ul><li>path: The path to the data you want to query<li>query: An object with custom queries you want to execute (optional)<li>tag: Unique number used to identify the query (optional)<li>hash: Hash of the query. Always empty.</ul><pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[p]ath"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTpath>,
</span><span>  </span><span style=color:#86b300>"[q]uery"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTquery>,
</span><span>  </span><span style=color:#86b300>"[t]ag"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTtag>,
</span><span>  </span><span style=color:#86b300>"[h]ash"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LThash>
</span><span>}
</span></code></pre><p>The response will contain the current value and all future updates. The <code>data</code> field will contain the JSON as it's stored in the database or <code>null</code> if not found.<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[s]tatus"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"ok"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"[d]ata"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTdata>
</span><span>}
</span></code></pre><h3 id=example-query-party-information>Example: Query party information</h3><p>We can find all the information about a party with the following request:<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[p]ath"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"/parties/-NeUUbtM3cqSazkSGvFb"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"[h]ash"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>""
</span><span>}
</span></code></pre><p>The response contains all the information about the party (playback status, settings, etc.):<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[p]ath"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"parties/-NeUUbtM3cqSazkSGvFb"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"[d]ata"</span><span style=color:#61676ccc>: </span><span>{
</span><span>    </span><span style=color:#86b300>"country"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"NL"</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"created_at"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1694892987111</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"created_by"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"YGQejUpKxXYUe07fOc1P2s8NQ622"</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"name"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"jukebox050's Party"</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"playback"</span><span style=color:#61676ccc>: </span><span>{
</span><span>      </span><span style=color:#86b300>"last_change"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1695439571657</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"last_position_ms"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>137393</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"playing"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>false
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"settings"</span><span style=color:#61676ccc>: </span><span>{
</span><span>      </span><span style=color:#86b300>"allow_anonymous_voters"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"allow_explicit_tracks"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"allow_multi_track_add"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"tv_mode_text"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"Add your songs on www.festify.us!"
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"short_id"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"885427"
</span><span>  }
</span><span>}
</span></code></pre><h3 id=example-query-all-parties>Example: Query all parties</h3><p>Querying a single party is cool, but can we dump all of them? Yes, we just have to change the path:<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[p]ath"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"/parties"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"[h]ash"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>""
</span><span>}
</span></code></pre><p>This returns all the parties ever created:<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[p]ath"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"parties"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"[d]ata"</span><span style=color:#61676ccc>: </span><span>{
</span><span>    </span><span style=color:#86b300>"-DE8BOdD2E0LDt6lBq6n"</span><span style=color:#61676ccc>: </span><span>{
</span><span>      </span><span style=color:#86b300>"country"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"DE"</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"created_at"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1513257439539</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"created_by"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"aYYftbv3wRWxZr8eowLx1KCJmPs1"</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"name"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"Today's Party"</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"playback"</span><span style=color:#61676ccc>: </span><span>{
</span><span>        </span><span style=color:#86b300>"last_change"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1513257439539</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#86b300>"last_position_ms"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#86b300>"playing"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>false
</span><span>      }</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"short_id"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"526655"
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f51818>...
</span><span>  }
</span><span>}
</span></code></pre><p>We can use <a href=https://github.com/jqlang/jq>jq</a> to analyze the data. 279.669 parties have been created since the launch of Festify in 2017. The top country is Germany, followed by the US and Brazil.<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>$</span><span> jq</span><span style=color:#ff8f40> -r </span><span style=color:#86b300>'.d.b.d[] | .country'</span><span> dump.json </span><span style=color:#ed9366>| </span><span style=color:#f29718>sort </span><span style=color:#ed9366>| </span><span style=color:#f29718>uniq</span><span style=color:#ff8f40> -c </span><span style=color:#ed9366>| </span><span style=color:#f29718>sort</span><span style=color:#ff8f40> -nr  
</span><span>  </span><span style=color:#f29718>89306</span><span> DE
</span><span>  </span><span style=color:#f29718>38237</span><span> US
</span><span>  </span><span style=color:#f29718>24120</span><span> BR
</span><span>  </span><span style=color:#f29718>19176</span><span> GB
</span><span>  </span><span style=color:#f29718>14711</span><span> NL
</span><span>   </span><span style=color:#f29718>7140</span><span> DK
</span><span>   </span><span style=color:#f29718>6251</span><span> CH
</span><span>   </span><span style=color:#f29718>5846</span><span> AU
</span><span>   </span><span style=color:#f29718>5376</span><span> CA
</span><span>   </span><span style=color:#f29718>4848</span><span> MX
</span><span>   </span><span style=color:#f29718>4709</span><span> BE
</span><span>   </span><span style=color:#f29718>4384</span><span> AT
</span><span>   </span><span style=color:#f29718>...
</span></code></pre><p>Most of them seem to be used for private parties, which can be seen by some of the names (<code>Parents at my age: "gRoWiNg/eVoLvInG FaMiLy", Me: tell your cat I said pspsps</code> is my personal favorite). Some of them are even used for weddings, prayers and company parties. Out of the 119.719 unique names the majority (80.767) are only used once. Most people use the default name <code>Today's Party</code>, followed by some power users:<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>$</span><span> jq</span><span style=color:#ff8f40> -r </span><span style=color:#86b300>'.d.b.d[] | .name'</span><span> fmt.json </span><span style=color:#ed9366>| </span><span style=color:#f29718>sort </span><span style=color:#ed9366>| </span><span style=color:#f29718>uniq</span><span style=color:#ff8f40> -c </span><span style=color:#ed9366>| </span><span style=color:#f29718>sort</span><span style=color:#ff8f40> -nr
</span><span>  </span><span style=color:#f29718>32333</span><span> Today</span><span style=color:#86b300>'s Party
</span><span style=color:#86b300>    488 wn8cleuqcwcm1excfj139ho1q'</span><span>s Party
</span><span>    </span><span style=color:#f29718>297</span><span> Spo</span><span style=color:#86b300>'s Party
</span><span style=color:#86b300>    289 Grant Bowering'</span><span>s Party
</span><span>    </span><span style=color:#f29718>238</span><span> Tsurox</span><span style=color:#86b300>'s Party
</span><span style=color:#86b300>    235 firefighter174'</span><span>s Party
</span></code></pre><p>37.592 parties have been created in the last year. Barely any of them are playing music, which makes sense since most of them are private parties.<h3 id=example-query-tracks-of-a-party>Example: Query tracks of a party</h3><p>What if we want to know the tracks in the queue of a party? Easy, just change the path and that's it.<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[p]ath"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"/tracks/-NeUUbtM3cqSazkSGvFb"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"[h]ash"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>""
</span><span>}
</span></code></pre><p>This returns a list of all tracks in the queue (including the fallback tracks).<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"p"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"tracks/-NeUUbtM3cqSazkSGvFb"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"d"</span><span style=color:#61676ccc>: </span><span>{
</span><span>    </span><span style=color:#86b300>"spotify-4cOdK2wGLETKBW3PvgPWqT"</span><span style=color:#61676ccc>: </span><span>{
</span><span>      </span><span style=color:#86b300>"added_at"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1697149626950</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"is_fallback"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"order"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>2256639839</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"reference"</span><span style=color:#61676ccc>: </span><span>{
</span><span>        </span><span style=color:#86b300>"id"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"4cOdK2wGLETKBW3PvgPWqT"</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#86b300>"provider"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"spotify"
</span><span>      }</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#86b300>"vote_count"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f51818>...
</span><span>  }
</span><span>}
</span></code></pre><h2 id=put-request>Put Request</h2><details><summary>Metadata</summary> <ul><li>Action: <code>p</code></ul></details><hr><p>Reading data is cool and all, but what if we want to change something? We can use the <a href=https://github.com/firebase/firebase-js-sdk/blob/cbfd14cfb27cda8a6de74be5d138ea9e6de09fe9/packages/database/src/core/PersistentConnection.ts#L547-L554>put requests</a> to change the data in the database. Depending on the path, the permissions can be different. When in doubt, check the <a href=https://github.com/Festify/app/blob/develop/database.rules.bolt>database.rules.bolt</a>.<p>The message contains the path again and the data that should be stored.<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[p]ath"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTpath>,
</span><span>  </span><span style=color:#86b300>"[d]ata"</span><span style=color:#61676ccc>: </span><span style=color:#f51818>&LTjson_data>
</span><span>}
</span></code></pre><p>The response will just contain the status field:<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[s]tatus"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"ok"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"[d]ata"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>null
</span><span>}
</span></code></pre><h3 id=example-vote-for-song>Example: Vote for song</h3><p>The following request will add a new song to the database.<pre class=language-json data-lang=json style=color:#61676c;background-color:#fafafa><code class=language-json data-lang=json><span>{
</span><span>  </span><span style=color:#86b300>"[p]ath"</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"/votes/&LTparty_id>/spotify-&LTsong_id>/&LTuser_id>"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"[d]ata"</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true
</span><span>}
</span></code></pre><p>To withdraw your vote, you can send the same request with <code>d</code> set to <code>null</code>.<hr><h1 id=putting-it-all-together>Putting it all together</h1><p>We learned how to authenticate, query and modify data in the database. These are all the building blocks we need to automate the process of voting for songs. I decided to write a Flutter app, to do exactly that and it worked like a charm!</p><style>video{max-width:100%;max-height:900px}.video-container{justify-content:space-around;display:flex}@media (width<=768px){.video-container{flex-direction:column}.video-container video{max-width:100%;max-height:auto}}</style><div class=video-container><div><b>Adding the song:</b><br><video controls><source src=bot_vote_rick_astley.mp4 type=video/mp4> Your browser does not support the video tag.</video></div><div><b>The result:</b><br><video controls><source src=rick-astley.mp4 type=video/mp4> Your browser does not support the video tag.</video></div></div><h1 id=mitigation>Mitigation</h1><p>The only way to prevent automated voting is to disable anonymous voting. Festify even provides such a setting, but it has not yet been enabled.<p>The reason is quite simple: You don't want to add too many unnecessary steps to the process of voting. Drunk people will most likely not want to enter their username and password just to add one song. The harder you make it to vote, the less people will vote.<h1 id=conclusion>Conclusion</h1><p>This was a fun project and I learned a lot about Firebase. I hope you enjoyed reading this article and learned something new.<p><img alt="Meme: I'm the DJ now" src=https://liuguilin361.github.io/posts/hacking-a-silent-disco/./im_the_dj_now.png></section></article></main></div>